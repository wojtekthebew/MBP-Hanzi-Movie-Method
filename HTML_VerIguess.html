<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinese Drama Manager</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .tabs { display: flex; margin-bottom: 20px; background: white; border-radius: 5px; }
        .tab { padding: 15px 25px; cursor: pointer; border: none; background: #e9ecef; }
        .tab.active { background: #007bff; color: white; }
        .tab-content { display: none; background: white; padding: 20px; border-radius: 0 5px 5px 5px; }
        .tab-content.active { display: block; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .item-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .item-card { border: 1px solid #ddd; padding: 15px; border-radius: 5px; background: #f8f9fa; }
        .item-actions { margin-top: 10px; }
        .delete-btn { background: #dc3545; }
        .delete-btn:hover { background: #c82333; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Chinese Drama Character Manager</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="openTab('actors')">Actors</button>
            <button class="tab" onclick="openTab('sets')">Sets</button>
            <button class="tab" onclick="openTab('props')">Props</button>
            <button class="tab" onclick="openTab('characters')">Characters</button>
        </div>

        <!-- Actors Tab -->
        <div id="actors" class="tab-content active">
            <h2>Actors</h2>
            <div class="form-grid">
                <div>
                    <h3>Add New Actor</h3>
                    <form onsubmit="addActor(event)">
                        <div class="form-group">
                            <label>Name:</label>
                            <input type="text" id="actorName" required>
                        </div>
                        <div class="form-group">
                            <label>Pinyin Initial:</label>
                            <input type="text" id="actorPinyin">
                        </div>
                        <button type="submit">Add Actor</button>
                    </form>
                </div>
            </div>
            <div id="actorsList" class="item-list"></div>
        </div>

        <!-- Sets Tab -->
        <div id="sets" class="tab-content">
            <h2>Set Locations</h2>
            <div class="form-grid">
                <div>
                    <h3>Add New Set</h3>
                    <form onsubmit="addSet(event)">
                        <div class="form-group">
                            <label>Name:</label>
                            <input type="text" id="setName" required>
                        </div>
                        <div class="form-group">
                            <label>Tone Sections (JSON):</label>
                            <textarea id="setTones" placeholder='{"1": "Section A", "2": "Section B"}'></textarea>
                        </div>
                        <button type="submit">Add Set</button>
                    </form>
                </div>
            </div>
            <div id="setsList" class="item-list"></div>
        </div>

        <!-- Props Tab -->
        <div id="props" class="tab-content">
            <h2>Props</h2>
            <div class="form-grid">
                <div>
                    <h3>Add New Prop</h3>
                    <form onsubmit="addProp(event)">
                        <div class="form-group">
                            <label>Name:</label>
                            <input type="text" id="propName" required>
                        </div>
                        <div class="form-group">
                            <label>Category:</label>
                            <input type="text" id="propCategory" value="general">
                        </div>
                        <div class="form-group">
                            <label>Components (comma separated):</label>
                            <input type="text" id="propComponents">
                        </div>
                        <button type="submit">Add Prop</button>
                    </form>
                </div>
            </div>
            <div id="propsList" class="item-list"></div>
        </div>

        <!-- Characters Tab -->
        <div id="characters" class="tab-content">
            <h2>Characters</h2>
            <div class="form-grid">
                <div>
                    <h3>Add New Character</h3>
                    <form onsubmit="addCharacter(event)">
                        <div class="form-group">
                            <label>Hanzi:</label>
                            <input type="text" id="charHanzi" required>
                        </div>
                        <div class="form-group">
                            <label>Pinyin:</label>
                            <input type="text" id="charPinyin" required>
                        </div>
                        <div class="form-group">
                            <label>Meaning:</label>
                            <input type="text" id="charMeaning" required>
                        </div>
                        <div class="form-group">
                            <label>Actor:</label>
                            <select id="charActor"></select>
                        </div>
                        <div class="form-group">
                            <label>Set Location:</label>
                            <select id="charSet"></select>
                        </div>
                        <div class="form-group">
                            <label>Tone Section:</label>
                            <input type="number" id="charToneSection" min="1" max="5">
                        </div>
                        <div class="form-group">
                            <label>Props:</label>
                            <select id="charProps" multiple></select>
                        </div>
                        <button type="submit">Add Character</button>
                    </form>
                </div>
            </div>
            <div id="charactersList" class="item-list"></div>
        </div>
    </div>

    <script>
        // Add file constants and use them as storage keys
        const ACTOR_FILE = 'data/actors.json';
        const SET_FILE = 'data/sets.json';
        const PROP_FILE = 'data/props.json';
        const CHARACTER_FILE = 'data/characters.json';

        const STORAGE_KEYS = {
            ACTORS: ACTOR_FILE,
            SETS: SET_FILE,
            PROPS: PROP_FILE,
            CHARACTERS: CHARACTER_FILE
        };

        // Utility functions
        function getNextId(items) {
            if (!items.length) return '1';
            const maxId = Math.max(...items.map(item => parseInt(item.id) || 0));
            return (maxId + 1).toString();
        }

        function loadData(key) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        }

        function saveData(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        // Seed localStorage from project files on first run
        async function ensureSeedData() {
            // Seed actors from data/actors.json if not present
            if (!localStorage.getItem(ACTOR_FILE)) {
                try {
                    const res = await fetch(ACTOR_FILE);
                    if (res.ok) {
                        const data = await res.json();
                        localStorage.setItem(ACTOR_FILE, JSON.stringify(data));
                    } else {
                        localStorage.setItem(ACTOR_FILE, JSON.stringify([]));
                    }
                } catch (e) {
                    // Network/file load failed â€” create empty fallback
                    localStorage.setItem(ACTOR_FILE, JSON.stringify([]));
                }
            }

            // Ensure other files exist in localStorage
            if (!localStorage.getItem(SET_FILE)) localStorage.setItem(SET_FILE, JSON.stringify([]));
            if (!localStorage.getItem(PROP_FILE)) localStorage.setItem(PROP_FILE, JSON.stringify([]));
            if (!localStorage.getItem(CHARACTER_FILE)) localStorage.setItem(CHARACTER_FILE, JSON.stringify([]));
        }

        // Tab management
        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Refresh data when switching tabs
            if (tabName === 'characters') {
                refreshCharacterForm();
            }
            refreshLists();
        }

        // Actor functions
        function addActor(event) {
            event.preventDefault();
            const actors = loadData(STORAGE_KEYS.ACTORS);
            const newActor = {
                id: getNextId(actors),
                name: document.getElementById('actorName').value,
                PinyinInitial: document.getElementById('actorPinyin').value,
                characters: []
            };
            actors.push(newActor);
            saveData(STORAGE_KEYS.ACTORS, actors);
            document.getElementById('actorName').value = '';
            document.getElementById('actorPinyin').value = '';
            refreshLists();
        }

        function deleteActor(id) {
            const actors = loadData(STORAGE_KEYS.ACTORS);
            const filteredActors = actors.filter(actor => actor.id !== id);
            saveData(STORAGE_KEYS.ACTORS, filteredActors);
            refreshLists();
        }

        // Set functions
        function addSet(event) {
            event.preventDefault();
            const sets = loadData(STORAGE_KEYS.SETS);
            const newSet = {
                id: getNextId(sets),
                name: document.getElementById('setName').value,
                tone_sections: JSON.parse(document.getElementById('setTones').value || '{}'),
                characters: []
            };
            sets.push(newSet);
            saveData(STORAGE_KEYS.SETS, sets);
            document.getElementById('setName').value = '';
            document.getElementById('setTones').value = '';
            refreshLists();
        }

        function deleteSet(id) {
            const sets = loadData(STORAGE_KEYS.SETS);
            const filteredSets = sets.filter(set => set.id !== id);
            saveData(STORAGE_KEYS.SETS, filteredSets);
            refreshLists();
        }

        // Prop functions
        function addProp(event) {
            event.preventDefault();
            const props = loadData(STORAGE_KEYS.PROPS);
            const newProp = {
                id: getNextId(props),
                name: document.getElementById('propName').value,
                category: document.getElementById('propCategory').value,
                components: document.getElementById('propComponents').value.split(',').map(c => c.trim()),
                used_by: []
            };
            props.push(newProp);
            saveData(STORAGE_KEYS.PROPS, props);
            document.getElementById('propName').value = '';
            refreshLists();
        }

        function deleteProp(id) {
            const props = loadData(STORAGE_KEYS.PROPS);
            const filteredProps = props.filter(prop => prop.id !== id);
            saveData(STORAGE_KEYS.PROPS, filteredProps);
            refreshLists();
        }

        // Character functions
        function refreshCharacterForm() {
            const actors = loadData(STORAGE_KEYS.ACTORS);
            const sets = loadData(STORAGE_KEYS.SETS);
            const props = loadData(STORAGE_KEYS.PROPS);
            
            const actorSelect = document.getElementById('charActor');
            const setSelect = document.getElementById('charSet');
            const propsSelect = document.getElementById('charProps');
            
            actorSelect.innerHTML = '<option value="">Select Actor</option>';
            setSelect.innerHTML = '<option value="">Select Set</option>';
            propsSelect.innerHTML = '';
            
            actors.forEach(actor => {
                const option = document.createElement('option');
                option.value = actor.id;
                option.textContent = actor.name;
                actorSelect.appendChild(option);
            });
            
            sets.forEach(set => {
                const option = document.createElement('option');
                option.value = set.id;
                option.textContent = set.name;
                setSelect.appendChild(option);
            });
            
            props.forEach(prop => {
                const option = document.createElement('option');
                option.value = prop.id;
                option.textContent = prop.name;
                propsSelect.appendChild(option);
            });
        }

        function addCharacter(event) {
            event.preventDefault();
            const characters = loadData(STORAGE_KEYS.CHARACTERS);
            const selectedProps = Array.from(document.getElementById('charProps').selectedOptions).map(opt => opt.value);
            
            const newCharacter = {
                id: getNextId(characters),
                hanzi: document.getElementById('charHanzi').value,
                pinyin: document.getElementById('charPinyin').value,
                meaning: document.getElementById('charMeaning').value,
                actor: document.getElementById('charActor').value,
                set_location: document.getElementById('charSet').value,
                tone_section: parseInt(document.getElementById('charToneSection').value) || 1,
                props: selectedProps,
                memory_scene: "",
                audio_file: ""
            };
            
            characters.push(newCharacter);
            saveData(STORAGE_KEYS.CHARACTERS, characters);
            
            // Reset form
            event.target.reset();
            refreshLists();
        }

        function deleteCharacter(id) {
            const characters = loadData(STORAGE_KEYS.CHARACTERS);
            const filteredCharacters = characters.filter(char => char.id !== id);
            saveData(STORAGE_KEYS.CHARACTERS, filteredCharacters);
            refreshLists();
        }

        // Display functions
        function refreshLists() {
            displayActors();
            displaySets();
            displayProps();
            displayCharacters();
        }

        function displayActors() {
            const actors = loadData(STORAGE_KEYS.ACTORS);
            const container = document.getElementById('actorsList');
            container.innerHTML = actors.map(actor => `
                <div class="item-card">
                    <h4>${actor.name}</h4>
                    <p>Pinyin: ${actor.PinyinInitial || 'N/A'}</p>
                    <p>Characters: ${actor.characters ? actor.characters.length : 0}</p>
                    <div class="item-actions">
                        <button class="delete-btn" onclick="deleteActor('${actor.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function displaySets() {
            const sets = loadData(STORAGE_KEYS.SETS);
            const container = document.getElementById('setsList');
            container.innerHTML = sets.map(set => `
                <div class="item-card">
                    <h4>${set.name}</h4>
                    <p>Tone Sections: ${Object.keys(set.tone_sections || {}).length}</p>
                    <p>Characters: ${set.characters ? set.characters.length : 0}</p>
                    <div class="item-actions">
                        <button class="delete-btn" onclick="deleteSet('${set.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function displayProps() {
            const props = loadData(STORAGE_KEYS.PROPS);
            const container = document.getElementById('propsList');
            container.innerHTML = props.map(prop => `
                <div class="item-card">
                    <h4>${prop.name}</h4>
                    <p>Category: ${prop.category}</p>
                    <p>Components: ${prop.components ? prop.components.join(', ') : 'None'}</p>
                    <p>Used by: ${prop.used_by ? prop.used_by.length : 0} characters</p>
                    <div class="item-actions">
                        <button class="delete-btn" onclick="deleteProp('${prop.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function displayCharacters() {
            const characters = loadData(STORAGE_KEYS.CHARACTERS);
            const actors = loadData(STORAGE_KEYS.ACTORS);
            const sets = loadData(STORAGE_KEYS.SETS);
            const props = loadData(STORAGE_KEYS.PROPS);
            
            const container = document.getElementById('charactersList');
            container.innerHTML = characters.map(character => {
                const actor = actors.find(a => a.id === character.actor);
                const set = sets.find(s => s.id === character.set_location);
                const characterProps = props.filter(p => character.props.includes(p.id));
                
                return `
                <div class="item-card">
                    <h4>${character.hanzi}</h4>
                    <p>Pinyin: ${character.pinyin}</p>
                    <p>Meaning: ${character.meaning}</p>
                    <p>Actor: ${actor ? actor.name : 'N/A'}</p>
                    <p>Set: ${set ? set.name : 'N/A'}</p>
                    <p>Tone Section: ${character.tone_section}</p>
                    <p>Props: ${characterProps.map(p => p.name).join(', ') || 'None'}</p>
                    <div class="item-actions">
                        <button class="delete-btn" onclick="deleteCharacter('${character.id}')">Delete</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            await ensureSeedData();
            refreshLists();
            refreshCharacterForm();
        });
    </script>
</body>
</html>